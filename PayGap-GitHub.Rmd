---
title: "Pay_Gap"
author: "Raquel Baltazar"
date: "`r format(Sys.time(), '%a %d %b %Y (%H:%M:%S)')`"
output:
  html_document:
    theme: united
    highlight: tango
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
  word_document:
    toc: yes
    toc_depth: '3'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

#  Gender pay gap in unadjusted form
% of average gross hourly earnings of men

The indicator measures the difference between average gross hourly earnings of male paid employees and of female paid employees as a percentage of average gross hourly earnings of male paid employees. The indicator has been defined as unadjusted, because it gives an overall picture of gender inequalities in terms of pay and measures a concept which is broader than the concept of equal pay for equal work. All employees working in firms with ten or more employees, without restrictions for age and hours worked, are included.
source: https://ec.europa.eu/eurostat/databrowser/view/sdg_05_20/

```{r library}

library("eurostat")
library(knitr)
library(kableExtra)
library(ggplot2)
library(magrittr)
library(data.table)
library(here)
library(countrycode)
library(gganimate)
theme_set(theme_bw())
library(gapminder)
library(data.table)

```

```{r query}
query <- search_eurostat(pattern = "Gender pay gap in unadjusted form", 
                         type = "table", fixed = FALSE)
query[, 1:2]
```


```{r get_eurostat}

ct <-  c("AT", "BE", "BG", "CH", "CY", "CZ", "DE", "DK", "EE", "EL", "ES", "FI", "FR", "HR","HU", "IE", "IS", "IT", "LI", "LT","LU", "LV", "MT", "NL", "NO", "PL", "PT","RO", "SE", "SI", "SK", "UK")

PTandEU <-  c("PT","EU27_2020")

```

```{r get}

dat <- get_eurostat(id="sdg_05_20", time_format = "num", 
                    filters = list (geo = ct))
dat [1:2,]

dat1<- get_eurostat(id="sdg_05_20", time_format = "num", 
                    filters = list (geo = PTandEU))
                    
dat1 [1:2,]
```


```{r label}
dat <- label_eurostat (dat)
dat[1:3,]


dat1 <- label_eurostat (dat1)
dat1[1:3,]
```


```{r clean_dat_dat1}

setDT(dat)

setDT(dat1)

dat[, c("unit", "nace_r2"):=NULL]

dat1[, c("unit", "nace_r2"):=NULL]

```

# Gender Pay Gap, 2002-2019

```{r eurostat_and_plots}
dat <- get_eurostat(id="sdg_05_20", filters = list(geo = ct))

library(ggplot2)
library(dplyr)
ggplot(dat, 
       aes(x = time, y= values, color = geo, label = geo)) + 
  geom_line (alpha = .5) +
  geom_text (data = dat %>% group_by(geo) %>% 
               filter(time == max(time)),
             size =2.6) +
  theme(legend.position = "none") + 
  labs(title = "Gender Pay Gap, 2002",
       x= "Year", y= "%")

  labs(title = 'Year: {frame_time}', x = 'Time', y = 'Percentage') +
  transition_time(time) +
  ease_aes('linear')
```


```{r animated_line}

ggplot(dat, aes(time, values, color = geo, label = geo)) +
  geom_line(alpha = .5) +
  geom_text (data = dat %>% group_by(geo) %>% 
               filter(time == max(time)),
             size =2.6) +
  theme(legend.position = "none") + 
  scale_color_viridis_d() +
  labs(x = "Year", y = "Gender Pay Gap") +
  theme(legend.position = "top") + 
  labs(title = "Gender Pay Gap",
       x= "Year", y= "%") +
  transition_reveal(time) +
  geom_point() +
  transition_reveal(time)

```



# Portugal vs. European Union, 2002-2019

```{r PT_vs_EU}

pteu <-  c("European Union - 27 countries (from 2020)","Portugal")

library(ggplot2)
library(dplyr)
ggplot(dat1, 
       aes(x = time, y= values, color = geo, label = geo)) + 
  geom_line (alpha = .5) +
  geom_text (data = dat1 %>% group_by(geo) %>% 
               filter(time == max(time)),
             size =2.6) +
  theme(legend.position = "none") + 
  labs(title = "Gender Pay Gap, 2002",
       x= "Year", y= "%")
```



```{r ptvseu_animated}


ggplot(dat1, aes(time, values, color = geo, label = geo)) +
  geom_line(alpha = .5) +
  geom_text (data = dat1 %>% group_by(geo) %>% 
               filter(time == max(time)),
             size =2.6) +
  theme(legend.position = "none") + 
  scale_color_viridis_d() +
  labs(x = "Year", y = "Gender Pay Gap") +
  theme(legend.position = "top") + 
  labs(title = "Gender Pay Gap",
       x= "Year", y= "%") +
  transition_reveal(time) +
  geom_point() +
  transition_reveal(time)


```

# Then vs Now (bar chart and map)

## Gender Pay Gap in 2002

### Bar Chart

```{r bar_chart}
dat_2002 <- dat %>% 
  filter(time == "2002-01-01")
ggplot (dat_2002, aes(x= reorder(geo, values), y = values)) + 
  geom_col (color = "white", fill = "grey80") + 
  theme ( axis.text.x = element_text (size = 6)) + 
  labs (title = "Gender Pay Gap in 2002", 
        y = "%", x = NULL)
```
only a few countries have available data


### Map
```{r map}

mapdata <-  get_eurostat_geospatial(nuts_level = 0) %>% 
  right_join (dat_2002) %>% 
  mutate (cat = cut_to_classes (values, n = 4, decimals = 1))
head(select(mapdata,geo,values,cat), 3)

```


```{r plot_map}

ggplot(mapdata, aes(fill = cat)) + 
  scale_fill_brewer(palette = "RdYlBu") + 
  geom_sf (color = alpha("white", 1/3), alpha = .6) + 
  xlim (c(-12,44)) + ylim(c(35, 70)) + 
  labs( title = "Gender Pay Gap in 2002",
        subtitle = "% of average gross hourly earnings of men",
        fill = "%")
```

## Gender Pay Gap in 2018

### Bar Chart

```{r bar_chart2}

dat_2018 <- dat %>% 
  filter(time == "2018-01-01")
ggplot (dat_2018, aes(x= reorder(geo, values), y = values)) + 
  geom_col (color = "white", fill = "grey80") + 
  theme ( axis.text.x = element_text (size = 6)) + 
  labs (title = "Gender Pay Gap in 2018", 
        y = "%", x = NULL)
```


### Map
```{r map2}

mapdata <-  get_eurostat_geospatial(nuts_level = 0) %>% 
  right_join (dat_2018) %>% 
  mutate (cat = cut_to_classes (values, n = 4, decimals = 1))
head(select(mapdata,geo,values,cat), 3)

```


```{r plot_map2}

ggplot(mapdata, aes(fill = cat)) + 
  scale_fill_brewer(palette = "RdYlBu") + 
  geom_sf (color = alpha("white", 1/3), alpha = .6) + 
  xlim (c(-12,44)) + ylim(c(35, 70)) + 
  labs( title = "Gender Pay Gap in 2019",
        subtitle = "% of average gross hourly earnings of men",
        fill = "%")
```


# ANIMATIONS FROM 2002 TO 2019

## Bar chart

```{r animated_bar_chart1}

ggplot (dat, aes(x= reorder(geo, values), y = values)) + 
  geom_col (color = "white", fill = "grey80") + 
  theme ( axis.text.x = element_text (size = 6)) + 
  labs( title = "Gender Pay Gap in 2019",
        subtitle = "% of average gross hourly earnings of men",
        fill = "%") + 
  labs(title = 'Year: {frame_time}') +
  transition_time(time) +
  ease_aes()
```

## Map

# this is not working...

is.data.table(dat) == TRUE
dat[, c("unit", "nace_r2"):=NULL]


```{r animated_plot}

mapdata <-  get_eurostat_geospatial(nuts_level = 0) %>% 
  right_join (dat) %>% 
  mutate (cat = cut_to_classes (values, n = 4, decimals = 1))
head(select(mapdata,geo,values,cat), 3)

ggplot(mapdata, aes(fill = cat)) + 
  scale_fill_brewer(palette = "RdYlBu") + 
  geom_sf (color = alpha("white", 1/3), alpha = .6) + 
  xlim (c(-12,44)) + ylim(c(35, 70)) + 
  labs( title = "Gender Pay Gap between 2002 and 2019",
        subtitle = "% of average gross hourly earnings of men",
        fill = "%") + 
  labs(title = 'Year: {frame_time}') +
  transition_time(time) +
  ease_aes()


```

```{r png_save}

anim_save(filename = "gm_animate.gif")

```
