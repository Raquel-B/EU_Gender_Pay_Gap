---
title: "Gender Pay Gap in the EU"
author: "Raquel Baltazar - With Saghir's Changes"
date: "`r format(Sys.time(), '%a %d %b %Y (%H:%M:%S)')`"
output:
  html_document:
    theme: united
    highlight: tango
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

**We will use Eurostat indicator data for “Gender pay gap in unadjusted form” to explore the geographical and time trends for the gender pay gap in the EU and compare Portugal with some European Union (EU) countries**

# Objective
The objective is to look at the geographical and time trends in the data. We will
answer the following questions:

+ What are the time trends for Portugal?
+ How does Portugal compare to other European countries?
+ Which countries have the largest and smallest pay gap in Europe over time?

# Understanding the Data

## Gender Pay Gap in Unadjusted Form

**Unit of Measure:** *% of average gross hourly earnings of men.*


> The indicator measures the difference between average gross hourly earnings of male paid employees and of female paid employees as a percentage of average gross hourly earnings of male paid employees. The indicator has been defined as unadjusted, because it gives an overall picture of gender inequalities in terms of pay and measures a concept which is broader than the concept of equal pay for equal work. All employees working in firms with ten or more employees, without restrictions for age and hours worked, are included.

Taken from (https://ec.europa.eu/eurostat/databrowser/view/sdg_05_20/)

## Data Source 

The Eurostat gender pay gap data is from the "Structure of Earnings Survey (SES)" and 
is based on data reported by the countries.

+ Eurostat Indicator code: SDG_05_20
+ Source link: https://ec.europa.eu/eurostat/databrowser/view/sdg_05_20/

The data is **Copyrighted** by Eurostat [Copyright/Licence Policy](http://ec.europa.eu/eurostat/statistics-explained/index.php/Copyright/licence_policy) is applicable.

## Further Information

Please see (https://ec.europa.eu/eurostat/cache/metadata/en/sdg_05_20_esmsip2.htm)
for further information about the data.

# Loading Libraries

```{r loadPackges}
library(eurostat)
library(data.table)
library(magrittr)
library(knitr)
library(kableExtra)
library(ggplot2)
library(ggrepel)
library(gganimate)
```

# Data processing

## Download data from Eurostat

Selecting all the available pay gap data (indicator code `sdg_05_20`) from Eurostat.

```{r getData}
# Get all EU data in one go and keep the country code (`geo_code`)
pgapEU <- get_eurostat(id="sdg_05_20", time_format = "num") %>% 
  label_eurostat(., code = "geo")

# We will work with the `data.table` package.
setDT(pgapEU)

# Update the `geo` variable to make it print and plot friendly.
pgap <- pgapEU[, geo_orig := geo] %>%
  .[, geo := fifelse(geo_code == "DE", "Germany", geo)] %>%
  .[, geo := fifelse(grepl("^EU|^EA", geo_code), gsub("_", " ", geo_code), geo)] %>% 
# Creating a variable geo_label to label lines just once.
# %>%  .[, lastYear := max(time), .(geo_code)] %>% 
  .[, geo_label := ifelse(time == max(time), geo_code, ""), .(geo_code)] %>% 
  .[, c("nace_r2"):=NULL]
```

We will highlight some countries to compare Portugal with.
```{r compareCountries}
# Define a list of countries of interes that will be used later.
ct <-  c("AT", "BE", "DE", "ES", "FR", "NL", "IT", "PT", "GR")
PTEU <-  c("PT","EU27_2020")
```


## Data summaries

Some data summaries to understand the data that we have.

```{r dataSummary}
# Distinct years
pgap[, c(time)] %>% unique(.) %>% sort(.)

# Distinct Countries
pgap[, c(geo)] %>% unique(.) %>% sort(.)

# Information by country
pgap[, .(countryData = sprintf("%2s %15s: %4.0f-%4.0f (%2.0f)", geo_code, geo, min(time), max(time), .N)),
     .(geo_code, geo)] %>% 
    .[, c(countryData)] %>% 
  unique(.) %>%  sort(.)
```


# Evolution of Gender Pay Gap in EU, from 2002-2018

## Line graph

```{r eurostat_and_plots}
pgap[geo_code %chin% ct] %>% 
ggplot(aes(x = time, y= values, color = geo, label = geo)) + 
  geom_line (alpha = .8, size = 1) +
  scale_y_continuous(breaks = seq(0, 30, 5), limits = c(0,30)) +
  scale_x_continuous(breaks = seq(2002, 2018, 2), limits = c(2002, 2019)) +
  theme(legend.position = "none") + 
  geom_text_repel(aes(label=geo_label),
                  direction = "y",
                  nudge_x = .45,
                  segement.alpha = 0.7) +
  labs(title = "Gender Pay Gap, 2003-2018",
       x= "Year", 
       y= "% Average Difference",
       caption = "Unadjusted % difference between average gross hourly earnings of male paid employees and of females."
       )
```

## ... The same line graph, but animated

```{r animated_line}
pgap %>% 
ggplot(aes(time, values, color = geo, label = geo)) +
  geom_line(alpha = .5) +
 theme(legend.position = "none") + 
  scale_color_viridis_d() +
  labs(x = "Year", y = "Gender Pay Gap") +
  theme(legend.position = "top") + 
  labs(title = "Gender Pay Gap, 2002-2018",
       x= "Year", y= "%") +
  transition_reveal(time) +
  geom_point()

```

## ... in an animated bar chart 

```{r animated_bar_chart1}
pgap %>% 
ggplot (aes(x= reorder(geo, values), y = values)) + 
  geom_col (color = "white", fill = "grey80") + 
  theme ( axis.text.x = element_text (size = 6)) + 
  labs( title = "Gender Pay Gap in 2019",
        subtitle = "% of average gross hourly earnings of men",
        fill = "%") + 
  labs(title = 'Year: {frame_time}') +
  transition_time(time) +
  ease_aes()
```

# Portugal vs. European Union, 2006-2018

**Portugal has no available data until 2006 and the EU only has available data from 2010 on**
(again, there is  no available data for 2019)

# line graph
```{r PT_vs_EU}

pteu <-  c("European Union - 27 countries (from 2020)","Portugal")

library(ggplot2)
library(dplyr)
ggplot(dat1, 
       aes(x = time, y= values, color = geo, label = geo)) + 
  geom_line (alpha = .5) +
  geom_text (data = dat1 %>% group_by(geo) %>% 
               filter(time == max(time)),
             size =2.6) +
  theme(legend.position = "none") + 
  labs(title = "Gender Pay Gap, 2006-2019",
       x= "Year", y= "%")
```

# Then vs Now 
Now we compare the first and the latest years [2002 vs. 2019] provided in the dataset individually.  

## Gender Pay Gap in 2002

### Bar Chart

```{r bar_chart}
dat_2002 <- dat %>% 
  filter(time == "2002-01-01")
ggplot (dat_2002, aes(x= reorder(geo, values), y = values)) + 
  geom_col (color = "white", fill = "grey80") + 
  theme ( axis.text.x = element_text (size = 6)) + 
  labs (title = "Gender Pay Gap in 2002", 
        y = "%", x = NULL)
```

### Map
```{r map}

mapdata <-  get_eurostat_geospatial(nuts_level = 0) %>% 
  right_join (dat_2002) %>% 
  mutate (cat = cut_to_classes (values, n = 4, decimals = 1))
head(select(mapdata,geo,values,cat), 3)

```


```{r plot_map}

ggplot(mapdata, aes(fill = cat)) + 
  scale_fill_brewer(palette = "RdYlBu") + 
  geom_sf (color = alpha("white", 1/3), alpha = .6) + 
  xlim (c(-12,44)) + ylim(c(35, 70)) + 
  labs( title = "Gender Pay Gap in 2002",
        subtitle = "% of average gross hourly earnings of men",
        fill = "%")
```


**only a few countries have available data for 2002**
**Portugal only has available data from 2006 on**

## Let's try using 2006 as a starting point

### Bar chart
```{r bar_chart1}

library(gghighlight)

dat_2006 <- dat %>% 
  filter(time == "2006-01-01")
ggplot (dat_2006, aes(x= reorder(geo, values), y = values)) + 
  geom_col (color = "white", fill = "tomato") + 
  gghighlight(geo == "PT") +
  theme ( axis.text.x = element_text (size = 6)) + 
  labs (title = "Gender Pay Gap in 2006", 
        y = "%", x = NULL)
```

**Portugal is highlighted for analysis and comparison**

### Map
```{r map1}

mapdata <-  get_eurostat_geospatial(nuts_level = 0) %>% 
  right_join (dat_2006) %>% 
  mutate (cat = cut_to_classes (values, n = 4, decimals = 1))
head(select(mapdata,geo,values,cat), 3)

```


```{r plot_map1}

ggplot(mapdata, aes(fill = cat)) + 
  scale_fill_brewer(palette = "RdYlBu") + 
  geom_sf (color = alpha("white", 1/3), alpha = .6) + 
  xlim (c(-12,44)) + ylim(c(35, 70)) + 
  labs( title = "Gender Pay Gap in 2006",
        subtitle = "% of average gross hourly earnings of men",
        fill = "%")
```
## Gender Pay Gap in 2018

(again, there is  no available data for 2019)

### Bar Chart

```{r bar_chart2}

dat_2018 <- dat %>% 
  filter(time == "2018-01-01")
ggplot (dat_2018, aes(x= reorder(geo, values), y = values)) + 
  geom_col (color = "white", fill = "tomato") + 
  gghighlight(geo == "PT") +
  theme ( axis.text.x = element_text (size = 6)) + 
  labs (title = "Gender Pay Gap in 2018", 
        y = "%", x = NULL)
```

### Map
```{r map2}

mapdata <-  get_eurostat_geospatial(nuts_level = 0) %>% 
  right_join (dat_2018) %>% 
  mutate (cat = cut_to_classes (values, n = 4, decimals = 1))
head(select(mapdata,geo,values,cat), 3)

```


```{r plot_map2}

ggplot(mapdata, aes(fill = cat)) + 
  scale_fill_brewer(palette = "RdYlBu") + 
  geom_sf (color = alpha("white", 1/3), alpha = .6) + 
  xlim (c(-12,44)) + ylim(c(35, 70)) + 
  labs( title = "Gender Pay Gap in 2018",
        subtitle = "% of average gross hourly earnings of men",
        fill = "%")
```


